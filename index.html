<!DOCKTYPE html>

<html>
  <head>

    <style>
      #controls {
          margin-bottom: 10px;
      }
      #controls form {
          width: 350px;
          height: 40px;
      }
      #transport {
          margin-bottom: 10px;
      }
      #sounds {
          float: right;
      }
      table, td {
          border-collapse: collapse;
      }
      td {
          width: 40px;
          text-align: center;
      }
      tr.divider {
          height: 10px;
      }
      td.current {
          background-color: lightgreen;
      }
      td.current.sam {
          background-color: lightsalmon;
      }
      td.current.tali {
          background-color: lightseagreen;
      }
      td.current.kali {
          background-color: lightblue;
      }
      .bandish.currentline {
          background-color: lightgray;
      }
    </style>

  </head>

  <body>
    <div id="controls">
      <div id="transport">
        <button onclick="play()">Play</button>
        <button onclick="stop()">Stop</button>
      </div>

      <form>
        <input id="bpm" type="number" min="1" max="300" value="60" onchange="setBpm()"/>
        <label for="bpm">BPM</label>
        <input id="bpmSlider" type="range" min="1" max="300" value="60" onchange="setBpmSlider()"/>

        <div id="sounds">
          <div>
            <input type="checkbox" id="cb-chime"/><label for="cb-chime">chime</label>
          </div>
          <div>
            <input type="checkbox" id="cb-click"/><label for="cb-click">click</label>
          </div>
        </div>
      </form>
    </div>

    <table>
      <tbody>
        <tr id="angas">
          <td class="sam">+</td>
          <td/>
          <td class="kali">o</td>
          <td/>
          <td class="tali">3</td>
          <td/>
          <td class="kali">o</td>
          <td/>
          <td class="tali">5</td>
          <td/>
          <td class="tali">6</td>
          <td/>
        </tr>
        <tr id="beats">
          <td class="sam">1</td>
          <td>2</td>
          <td class="kali">3</td>
          <td>4</td>
          <td class="tali">5</td>
          <td>6</td>
          <td class="kali">7</td>
          <td>8</td>
          <td class="tali">9</td>
          <td>10</td>
          <td class="tali">11</td>
          <td>12</td>
        </tr>
        <tr id="bols">
          <td class="sam">Dha</td>
          <td>Dha</td>
          <td class="kali">Dhin</td>
          <td>Ta</td>
          <td class="tali">Ki te</td>
          <td>Da</td>
          <td class="kali">Dhin</td>
          <td>Ta</td>
          <td class="tali">Te te</td>
          <td>Ka te</td>
          <td class="tali">Ga de</td>
          <td>Ge na</td>
        </tr>

        <tr class="divider"/>

        <tr class="bandish">
          <td class="sam">
            <div>A</div>
            <div>P</div>
            <div>/</div>
          </td>
          <td>
            <div>-</div>
            <div>m</div>
            <div>-</div>
          </td>
          <td class="kali">
            <div>nan</div>
            <div>G</div>
            <div>-</div>
          </td>
          <td>
            <div>-</div>
            <div>-</div>
            <div>c</div>
          </td>
          <td class="tali">
            <div>di</div>
            <div>G</div>
            <div>\</div>
          </td>
          <td>
            <div>-</div>
            <div>R</div>
            <div>-</div>
          </td>
          <td class="kali">
            <div>Ja</div>
            <div>S</div>
            <div>/</div>
          </td>
          <td>
            <div>ga</div>
            <div><u>N</u></div>
            <div>\</div>
          </td>
          <td class="tali">
            <div>-</div>
            <div><u>D</u></div>
            <div>-</div>
          </td>
          <td>
            <div>Ban</div>
            <div><u>N</u></div>
            <div>/</div>
          </td>
          <td class="tali">
            <div>-</div>
            <div>R</div>
            <div>-</div>
          </td>
          <td>
            <div>di</div>
            <div>S</div>
            <div>\</div>
          </td>
        </tr>
        <tr class="bandish">
          <td class="sam">
            <div>Tri</div>
            <div>S</div>
            <div>/</div>
          </td>
          <td>
            <div>pu</div>
            <div>S</div>
            <div>/</div>
          </td>
          <td class="kali">
            <div>ra</div>
            <div>S</div>
            <div>\</div>
          </td>
          <td>
            <div>Sun</div>
            <div>(R)<u>N</u></div>
            <div>/</div>
          </td>
          <td class="tali">
            <div>-</div>
            <div>-</div>
            <div>-</div>
          </td>
          <td>
            <div>da</div>
            <div>R</div>
            <div>-</div>
          </td>
          <td class="kali">
            <div>ri</div>
            <div>S</div>
            <div>/</div>
          </td>
          <td>
            <div>-</div>
            <div>-</div>
            <div>c</div>
          </td>
          <td class="tali">
            <div>Ma</div>
            <div>S</div>
            <div>/</div>
          </td>
          <td>
            <div>-</div>
            <div>-</div>
            <div>c</div>
          </td>
          <td class="tali">
            <div>ta</div>
            <div>S</div>
            <div>\</div>
          </td>
          <td>
            <div>-</div>
            <div>-</div>
            <div>c</div>
          </td>
        </tr>
      </tbody>
    </table>

    <audio id="sam">
      <source src="media/glass.ogg" type="audio/ogg"/>
    </audio>

    <audio id="click">
      <source src="media/click.ogg" type="audio/ogg"/>
    </audio>

  </body>
</html>

<script>
  const intervalBase = 60000;
  const sam = document.getElementById("sam")
  const click = document.getElementById("click")
  const cbChime = document.getElementById("cb-chime")
  const cbClick = document.getElementById("cb-click")

  var currentMatra = 0;
  var currentLine = 0
  var angas = document.getElementById("angas").children;
  var beats = document.getElementById("beats").children;
  var bols = document.getElementById("bols").children;
  var bandish = document.getElementsByClassName("bandish")
  var bandishLine
  var loop;

  function setBandishLine() {
    if (bandishLine != undefined) bandishLine.classList.toggle("currentline");
    bandishLine = bandish[currentLine];
    bandishLine.classList.toggle("currentline");
  }

  function setBpm() {
    document.getElementById("bpmSlider").value = document.getElementById("bpm").value;
    if (loop != undefined) play();
  }

  function setBpmSlider() {
    document.getElementById("bpm").value = document.getElementById("bpmSlider").value;
    if (loop != undefined) play();
  }

  function toggleCurrent() {
    [angas, beats, bols, bandishLine.children].forEach((cells, i) => {
      cells[currentMatra].classList.toggle("current")
    });
  }

  function next(i) {
    toggleCurrent();
    if (typeof(i) == "number" && i >= 0 && i < beats.length) { currentMatra = i; }
    else { ++currentMatra == beats.length && (currentMatra = 0); }
    if (currentMatra == 0) {
      if (i === 0 || (++currentLine == bandish.length)) currentLine = 0;
      setBandishLine()
      loop != undefined && cbChime.checked && triggerSound(sam);
    }
    loop != undefined && cbClick.checked && triggerSound(click);
    toggleCurrent();
    return currentMatra;
  }
  
  function play() {
    loop && clearInterval(loop);
    let interval = intervalBase / document.getElementById("bpm").value;
    currentMatra == 0 && cbChime.checked && triggerSound(sam);
    loop = setInterval(next, interval);
  }

  function stop() {
    if (loop === undefined) next(0);
    else {
      clearInterval(loop);
      loop = undefined;
    }
  }

  function triggerSound(aObj) {
    if (aObj.played.length === 0 || aObj.ended) aObj.play(); // never played or playback ended
    else aObj.currentTime = 0;                               // playing
  }

  // init
  setBandishLine()
  toggleCurrent()

</script>
