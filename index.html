<!DOCKTYPE html>

<html>
  <head>

    <style>
      #transport {
          padding-bottom: 20px;
      }
      table, td {
          border-collapse: collapse;
      }
      td {
          width: 40px;
          text-align: center;
      }
      tr.divider {
          height: 10px;
      }
      #angas .current {
          background-color: lightgreen;
      }
      #angas .anga.current.sam {
          background-color: lightsalmon;
      }
      #angas .anga.current.tali {
          background-color: lightseagreen;
      }
      #angas .anga.current.kali {
          background-color: lightblue;
      }
      #beats .current {
          background-color: lightgreen;
      }
      #bols .current {
          background-color: lightgreen;
      }
      .bandish .current {
          background-color: lightgreen;
      }
      .bandish.currentline {
          background-color: lightgray;
      }
    </style>

  </head>

  <body>
    <form>
      <input id="bpmSlider" type="range" min="1" max="300" value="60" onchange="setBpmSlider()"/>
      <input id="bpm" type="number" min="1" max="300" value="60" onchange="setBpm()"/>
    </form>

    <div id="transport">
      <button onclick="play()">Play</button>
      <button onclick="stop()">Stop</button>
    </div>

    <table>
      <tbody>
        <tr id="angas">
          <td class="anga sam current">+</td>
          <td/>
          <td class="anga kali">o</td>
          <td/>
          <td class="anga tali">3</td>
          <td/>
          <td class="anga kali">o</td>
          <td/>
          <td class="anga tali">5</td>
          <td/>
          <td class="anga tali">6</td>
          <td/>
        </tr>
        <tr id="beats">
          <td class="current">1</td>
          <td>2</td>
          <td>3</td>
          <td>4</td>
          <td>5</td>
          <td>6</td>
          <td>7</td>
          <td>8</td>
          <td>9</td>
          <td>10</td>
          <td>11</td>
          <td>12</td>
        </tr>
        <tr id="bols">
          <td class="current">Dha</td>
          <td>Dha</td>
          <td>Dhin</td>
          <td>Ta</td>
          <td>Ki te</td>
          <td>Da</td>
          <td>Dhin</td>
          <td>Ta</td>
          <td>Te te</td>
          <td>Ka te</td>
          <td>Ga de</td>
          <td>Ge na</td>
        </tr>
        <tr class="divider"/>
        <tr class="bandish">
          <td class="current">
            <div>A</div>
            <div>P</div>
          </td>
          <td>
            <div>-</div>
            <div>m</div>
          </td>
          <td>
            <div>nan</div>
            <div>G</div>
          </td>
          <td>
            <div>-</div>
            <div>-</div>
          </td>
          <td>
            <div>di</div>
            <div>G</div>
          </td>
          <td>
            <div>-</div>
            <div>R</div>
          </td>
          <td>
            <div>Ja</div>
            <div>S</div>
          </td>
          <td>
            <div>ga</div>
            <div><u>N</u></div>
          </td>
          <td>
            <div>-</div>
            <div><u>D</u></div>
          </td>
          <td>
            <div>Ban</div>
            <div><u>N</u></div>
          </td>
          <td>
            <div>-</div>
            <div>R</div>
          </td>
          <td>
            <div>di</div>
            <div>S</div>
          </td>
        </tr>
        <tr class="bandish">
          <td>
            <div>Tri</div>
            <div>S</div>
          </td>
          <td>
            <div>pu</div>
            <div>S</div>
          </td>
          <td>
            <div>ra</div>
            <div>S</div>
          </td>
          <td>
            <div>Sun</div>
            <div>(R)<u>N</u></div>
          </td>
          <td>
            <div>-</div>
            <div>-</div>
          </td>
          <td>
            <div>da</div>
            <div>R</div>
          </td>
          <td>
            <div>ri</div>
            <div>S</div>
          </td>
          <td>
            <div>-</div>
            <div>-</div>
          </td>
          <td>
            <div>Ma</div>
            <div>S</div>
          </td>
          <td>
            <div>-</div>
            <div>-</div>
          </td>
          <td>
            <div>ta</div>
            <div>S</div>
          </td>
          <td>
            <div>-</div>
            <div>-</div>
          </td>
        </tr>
      </tbody>
    </table>

    <audio id="sam">
      <source src="media/glass.ogg" type="audio/ogg"/>
    </audio>

  </body>
</html>

<script>
  const intervalBase = 60000;

  var currentMatra = 0;
  var angas = document.getElementById("angas").children;
  var beats = document.getElementById("beats").children;
  var bols = document.getElementById("bols").children;
  var bandish = document.getElementsByClassName("bandish")
  var bandishLine
  var lineIndex = 0
  const sam = document.getElementById("sam")
  var loop;

  function setBandishLine() {
    if (bandishLine != undefined) bandishLine.classList.toggle("currentline");
    bandishLine = bandish[lineIndex];
    bandishLine.classList.toggle("currentline");
  }
  setBandishLine()

  function setBpm() {
    document.getElementById("bpmSlider").value = document.getElementById("bpm").value;
    if (loop != undefined) play();
  }

  function setBpmSlider() {
    document.getElementById("bpm").value = document.getElementById("bpmSlider").value;
    if (loop != undefined) play();
  }

  function toggleCurrent() {
    [angas, beats, bols, bandishLine.children].forEach((cells, i) => {
      cells[currentMatra].classList.toggle("current")
    });
  }

  function next(i) {
    toggleCurrent();
    if (typeof(i) == "number" && i >= 0 && i < beats.length) { currentMatra = i; }
    else { ++currentMatra == beats.length && (currentMatra = 0); }
    if (currentMatra == 0) {
      if (i === 0 || (++lineIndex == bandish.length)) lineIndex = 0;
      setBandishLine()
      loop != undefined && sam.play();
    }
    toggleCurrent();
    return currentMatra;
  }
  
  function play() {
    loop && clearInterval(loop);
    let interval = intervalBase / document.getElementById("bpm").value;
    if (currentMatra == 0) sam.play();
    loop = setInterval(next, interval);
  }

  function stop() {
    if (loop === undefined) next(0);
    else {
      clearInterval(loop);
      loop = undefined;
    }
  }

</script>
